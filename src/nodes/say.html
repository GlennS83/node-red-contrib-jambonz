<script type="text/javascript">
  RED.nodes.registerType('say',{
      category: 'jambonz',
      color: '#a6bbcf',
      defaults: {
        name: {value: ''},
        text: {required: true},
        early: {
          value: false
        },
        loop: {
          value: 1
        },
        vendor: {value: 'default'},
        lang: {value: 'default'},
        voice: {value: 'default'}
      },
      inputs:1,
      outputs:1,
      icon: "file.png",
      label: function() { return this.name || 'say';},
      oneditprepare: function() {
        buildEditPanel(this);
      }
  });
</script>

<script type="text/html" data-template-name="say">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>
<div class="form-row">
  <label for="node-input-text"><i class="icon-tag"></i> Text</label>
  <textarea id="node-input-text" rows="4" placeholder="Text or SSML to speak" style="width:70%"></textarea>
</div>
<div class="form-row">
  <label for="node-input-early"><i class="icon-tag"></i>Early media</label>
  <input type="checkbox" id="node-input-early">
</div>
<div class="form-row">
  <label for="node-input-loop"><i class="icon-tag"></i>Loop</label>
  <input type="input" id="node-input-loop" placeholder="number of times to repeat"> 
</div>
<fieldset>
  <legend>Speech synthesis options</legend>
  <div class="form-row">
    <label for="node-input-vendor"><i class="icon-tag"></i> Vendor</label>
    <select id="node-input-vendor">
      <option value="default" selected>--application default--</option>
      <option value="google">google</option>
      <option value="aws">aws/polly</option>
    </select>
  </div>
  <div class="form-row">
    <label for="node-input-lang"><i class="icon-tag"></i> Language</label>
    <select id="node-input-lang">
      <option value="default" selected>--application default--</option>
    </select>
  </div>
  <div class="form-row">
    <label for="node-input-voice"><i class="icon-tag"></i> Voice</label>
    <select id="node-input-voice">
      <option value="default" selected>--application default--</option>
    </select>
  </div>
</fieldset>
</script>

<script type="text/html" data-help-name="say">
  <p>Synthesize speech from text or SSML</p>
</script>

<script type="text/javascript">
  "use strict";

  let mapGoogle = {};
  let googleLanguageOptions = '';
  let mapAws = {};
  let awsLanguageOptions = '';
  let mapSpeechRec = {};
  let speechRecOptions = '';

  var googleUrl = (RED.settings.httpNodeRoot || RED.settings.httpAdminRoot || "").replace(/\/$/, "") + '/googleTts';
  $.getJSON(googleUrl, function (data) {
    console.log('retrieved data ' + JSON.stringify(data));
    data.forEach(function(l) {
      mapGoogle[l.code] = {
        name: l.name,
        voices: l.voices
      };
      googleLanguageOptions += `<option value="${l.code}">${l.name}</option>`;        
    });
  });
  var awsUrl = (RED.settings.httpNodeRoot || RED.settings.httpAdminRoot || "").replace(/\/$/, "") + '/awsTts';
  $.getJSON(awsUrl, function (data) {
    console.log('retrieved data ' + JSON.stringify(data));
    data.forEach(function(l) {
      mapAws[l.code] = {
        name: l.name,
        voices: l.voices
      };
      awsLanguageOptions += `<option value="${l.code}">${l.name}</option>`;        
    });
  });
  var speechRecUrl = (RED.settings.httpNodeRoot || RED.settings.httpAdminRoot || "").replace(/\/$/, "") + '/googleSpeech';
    $.getJSON(speechRecUrl, function (data) {
      console.log('retrieved data for recognizer voices: ' + JSON.stringify(data));
      data.forEach(function(l) {
        mapSpeechRec[l.code] = l.name;
        speechRecOptions += `<option value="${l.code}">${l.name}</option>`;        
      });
    });

  function buildEditPanel(node) {
    var vendorElem = $('#node-input-vendor');
    var langElem = $('#node-input-lang');
    var voiceElem = $('#node-input-voice');
  
    var onVendorChanged = function() {
      var vendor = vendorElem.find(':selected').val();

      console.log(`vendor changed to ${vendor}`);
      setLanguage(vendor);
    }

    var onLangChanged = function () {
      var vendor = vendorElem.find(':selected').val();
      var lang = langElem.find(':selected').val();
      console.log(`language changed to ${lang}`);
      setVoice(vendor, lang)
    }
  
    var setLanguage = function(v) {
      langElem.find('option').remove();
      voiceElem.find('option').remove();

      switch (v) {
        case 'default': 
          langElem.append('<option value="default" selected>--application default--</option>');
          voiceElem.append('<option value="default" selected>--application default--</option>');
          node.lang = 'default';
          node.voice = 'default';
          break;

        case 'google':
          langElem.append(googleLanguageOptions);
          break;

        case 'aws':
          langElem.append(awsLanguageOptions);
          break;
      }
      langElem.val(node.lang);
    }

    var setVoice = function(vendor, lang) {
      console.log(`set voice for language ${lang} vendor ${vendor}`);
      voiceElem.find('option').remove();

      switch (vendor) {
        case 'default':
          voiceElem.append('<option value="default" selected>--application default--</option>');
          break;

        case 'google':
        case 'aws':
          var obj = 'google' === vendor ? mapGoogle[lang] : mapAws[lang];
          if (obj) {
            var options = '';
            for (var i = 0; i < obj.voices.length; i++) {
              if (i) options += `<option value="${obj.voices[i].value}">${obj.voices[i].name}</option>`;
              else options += `<option value="${obj.voices[i].value}">${obj.voices[i].name}</option>`;
            }
            voiceElem.append(options);
          }
          break;
      }
      voiceElem.val(node.voice);
    }

    vendorElem.change(onVendorChanged);
    langElem.change(onLangChanged);

  }


</script>